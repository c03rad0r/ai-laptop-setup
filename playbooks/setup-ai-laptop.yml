- name: Setup AI Laptop with Essential Tools
  hosts: localhost
  become: yes
  vars:
    user_name: "{{ lookup('env', 'SUDO_USER') or ansible_user_id }}"
    
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      
    - name: Install common packages
      apt:
        name:
          - git
          - htop
          - terminator
        state: present

    - name: Set Terminator as default terminal
      ansible.builtin.shell:
        cmd: update-alternatives --install /usr/bin/x-terminal-emulator x-terminal-emulator /usr/bin/terminator 20
      args:
        creates: /etc/alternatives/x-terminal-emulator

    - name: Ensure keyrings directory exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

        
    - name: Install Emacs
      apt:
        name: emacs
        state: present
        

#    - name: Download Microsoft GPG key
#      ansible.builtin.get_url:
#        url: https://packages.microsoft.com/keys/microsoft.asc
#        dest: /tmp/microsoft.asc
#        mode: '0644'
#        force: true
#
#    - name: De-armor Microsoft GPG key
#      ansible.builtin.command:
#        cmd: gpg --dearmor --output /etc/apt/keyrings/microsoft.gpg /tmp/microsoft.asc
#        creates: /etc/apt/keyrings/microsoft.gpg
#      become: true
#
#    - name: Clean up temporary GPG key
#      ansible.builtin.file:
#        path: /tmp/microsoft.asc
#        state: absent
#
#    - name: Add Visual Studio Code repository
#      apt_repository:
#        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/vscode stable main"
#        state: present
#        filename: vscode
#
#    - name: Install Visual Studio Code
#      apt:
#        name: code
#        state: present
#        update_cache: yes

    - name: Install ngit
      become_user: "{{ user_name }}"
      ansible.builtin.shell:
        cmd: curl -Ls https://ngit.dev/install.sh | bash
        creates: "/home/{{ user_name }}/.ngit/bin/ngit"

    - name: Install dependencies for rana
      apt:
        name:
          - cmake
          - build-essential
          - cargo
        state: present

    - name: Install rana
      become_user: "{{ user_name }}"
      community.general.cargo:
        name: rana
        state: present

    - name: Create rana service file
      ansible.builtin.template:
        src: ../roles/common-tools/templates/rana.service.j2
        dest: /etc/systemd/system/rana.service
        owner: root
        group: root
        mode: '0644'

    - name: Copy manage-rana-service.sh script
      ansible.builtin.copy:
        src: ../roles/common-tools/files/manage-rana-service.sh
        dest: /usr/local/bin/manage-rana-service.sh
        owner: root
        group: root
        mode: '0755'

    - name: Copy udev rule for rana service
      ansible.builtin.copy:
        src: ../roles/common-tools/files/99-rana-power.rules
        dest: /etc/udev/rules.d/99-rana-power.rules
        owner: root
        group: root
        mode: '0644'

    - name: Reload udev rules
      ansible.builtin.command:
        cmd: udevadm control --reload-rules

    - name: Trigger udev events
      ansible.builtin.command:
        cmd: udevadm trigger

    - name: Disable rana service from starting on boot
      ansible.builtin.systemd:
        name: rana
        enabled: no
        state: stopped
        daemon_reload: yes
