- name: Setup Sovereign Nostr and Cashu Stack
  hosts: all
  become: yes
  vars:
    # IMPORTANT: Replace with your actual domain and Nostr public key
    nostr_public_key: "YOUR_NOSTR_PUBLIC_KEY"
    blossom_domain: "blossom.yourdomain.com"
    relay_domain: "relay.yourdomain.com"
    bostr_domain: "bostr.yourdomain.com"
    mint_domain: "mint.yourdomain.com"
    user_home: "{{ ansible_env.HOME }}"

    # Cashu Configuration
    cashu_ln_backend: "FakeWallet" # Can be Lnbits, LND, CLN, or FakeWallet
    # Public key for creating P2PK-locked vouchers (client-side operation)
    cashu_voucher_pubkey: "YOUR_P2PK_PUBLIC_KEY" # IMPORTANT: Replace with your key

    # Bostr Configuration
    bostr_port: 7777

  tasks:
    # 1. VPS Preparation & Tooling
    - name: Update and upgrade apt packages
      apt:
        update_cache: yes
        upgrade: dist
        autoremove: yes
      tags: ['system', 'prep']

    - name: Install required system packages
      apt:
        name:
          - docker.io
          - docker-compose
          - git
          - build-essential
          - curl
          - ufw
          - apt-transport-https
          - ca-certificates
          - gnupg
          - golang-go
        state: present
      tags: ['system', 'prep']

    - name: Check if Rust is installed
      command: "{{ user_home }}/.cargo/bin/cargo --version"
      register: rust_check
      ignore_errors: yes
      changed_when: false
      tags: ['system', 'rust']

    - name: Install Rust
      when: rust_check.failed
      shell: "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y"
      args:
        creates: "{{ user_home }}/.cargo/bin/rustc"
      tags: ['system', 'rust']

    # 2. Blossom Media Server (Nostr)
    - name: Create Blossom directory
      file:
        path: /opt/blossom
        state: directory
        mode: '0755'
      tags: ['blossom']

    - name: Create Blossom docker-compose.yml
      template:
        src: templates/blossom-docker-compose.yml.j2
        dest: /opt/blossom/docker-compose.yml
      tags: ['blossom']

    - name: Start Blossom service
      community.docker.docker_compose:
        project_src: /opt/blossom
        state: present
      tags: ['blossom']

    # 3. Khatru Nostr Relay
    - name: Create Khatru directory
      file:
        path: /opt/khatru
        state: directory
        mode: '0755'
      tags: ['khatru']

    - name: Clone Khatru Pyramid repository
      git:
        repo: 'https://github.com/fiatjaf/khatru-pyramid.git'
        dest: /opt/khatru/khatru-pyramid
        version: master
      tags: ['khatru']

    - name: Create Khatru docker-compose.yml
      template:
        src: templates/khatru-docker-compose.yml.j2
        dest: /opt/khatru/docker-compose.yml
      tags: ['khatru']

    - name: Start Khatru service
      community.docker.docker_compose:
        project_src: /opt/khatru
        state: present
      tags: ['khatru']

    # 3.5. Bostr Relay
    - name: Install bostr2 via go
      become: no # Run as the ansible user
      command: "go install codeberg.org/Yonle/bostr2@latest"
      args:
        creates: "{{ user_home }}/go/bin/bostr2"
      environment:
        GOPATH: "{{ user_home }}/go"
      tags: ['bostr']

    - name: Create bostr2 systemd service file
      template:
        src: templates/bostr2.service.j2
        dest: /etc/systemd/system/bostr2.service
        owner: root
        group: root
        mode: '0644'
      tags: ['bostr']

    - name: Enable and start bostr2 service
      systemd:
        name: bostr2
        daemon_reload: yes
        enabled: yes
        state: started
      tags: ['bostr']

    # 4. Cashu Mint (cdk-mintd)
    - name: Install cdk-mintd via cargo
      command: "{{ user_home }}/.cargo/bin/cargo install cdk-mintd"
      args:
        creates: "{{ user_home }}/.cargo/bin/cdk-mintd"
      tags: ['cashu']

    - name: Create cdk-mintd config directory
      file:
        path: "{{ user_home }}/.cdk-mintd"
        state: directory
        mode: '0755'
      tags: ['cashu']


    - name: Create cdk-mintd systemd service file
      template:
        src: templates/cdk-mintd.service.j2
        dest: /etc/systemd/system/cdk-mintd.service
        owner: root
        group: root
        mode: '0644'
      tags: ['cashu']

    - name: Enable and start cdk-mintd service
      systemd:
        name: cdk-mintd
        daemon_reload: yes
        enabled: yes
        state: started
      tags: ['cashu']

    # 5. Caddy Reverse Proxy
    - name: Add Caddy GPG key
      apt_key:
        url: "https://dl.cloudsmith.io/public/caddy/stable/gpg.key"
        state: present
      tags: ['caddy']

    - name: Add Caddy repository
      apt_repository:
        repo: "deb [arch=amd64] https://dl.cloudsmith.io/public/caddy/stable/deb/debian any-version main"
        state: present
      tags: ['caddy']

    - name: Install Caddy
      apt:
        name: caddy
        state: present
        update_cache: yes
      tags: ['caddy']

    - name: Create Caddyfile
      template:
        src: templates/Caddyfile.j2
        dest: /etc/caddy/Caddyfile
      vars:
        blossom_proxy: "localhost:3000"
        relay_proxy: "localhost:3334"
        bostr_proxy: "localhost:{{ bostr_port }}"
        mint_proxy: "localhost:8085"
      tags: ['caddy']

    - name: Enable and start Caddy service
      systemd:
        name: caddy
        enabled: yes
        state: started
      tags: ['caddy']

    - name: Allow HTTP and HTTPS traffic through firewall
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - "80"
        - "443"
      tags: ['caddy', 'firewall']
